"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const t=require("react"),$=require("@uiw/react-codemirror"),v=require("@codemirror/view"),R=require("@codemirror/state"),G=require("@codemirror/lang-javascript"),o=require("@lezer/highlight"),Q=require("@uiw/codemirror-themes"),W=require("react-hook-inview"),z=require("@strudel.cycles/webaudio"),X=require("@strudel.cycles/core"),Y=require("@strudel.cycles/transpiler"),V=e=>e&&typeof e=="object"&&"default"in e?e:{default:e},n=V(t),Z=V($),ee=Q.createTheme({theme:"dark",settings:{background:"#222",foreground:"#75baff",caret:"#ffcc00",selection:"rgba(128, 203, 196, 0.5)",selectionMatch:"#036dd626",lineHighlight:"#00000050",gutterBackground:"transparent",gutterForeground:"#8a919966"},styles:[{tag:o.tags.keyword,color:"#c792ea"},{tag:o.tags.operator,color:"#89ddff"},{tag:o.tags.special(o.tags.variableName),color:"#eeffff"},{tag:o.tags.typeName,color:"#c3e88d"},{tag:o.tags.atom,color:"#f78c6c"},{tag:o.tags.number,color:"#c3e88d"},{tag:o.tags.definition(o.tags.variableName),color:"#82aaff"},{tag:o.tags.string,color:"#c3e88d"},{tag:o.tags.special(o.tags.string),color:"#c3e88d"},{tag:o.tags.comment,color:"#7d8799"},{tag:o.tags.variableName,color:"#c792ea"},{tag:o.tags.tagName,color:"#c3e88d"},{tag:o.tags.bracket,color:"#525154"},{tag:o.tags.meta,color:"#ffcb6b"},{tag:o.tags.attributeName,color:"#c792ea"},{tag:o.tags.propertyName,color:"#c792ea"},{tag:o.tags.className,color:"#decb6b"},{tag:o.tags.invalid,color:"#ffffff"}]});const x=R.StateEffect.define(),te=R.StateField.define({create(){return v.Decoration.none},update(e,r){try{for(let a of r.effects)if(a.is(x))if(a.value){const s=v.Decoration.mark({attributes:{style:"background-color: #FFCA2880"}});e=v.Decoration.set([s.range(0,r.newDoc.length)])}else e=v.Decoration.set([]);return e}catch(a){return console.warn("flash error",a),e}},provide:e=>v.EditorView.decorations.from(e)}),j=e=>{e.dispatch({effects:x.of(!0)}),setTimeout(()=>{e.dispatch({effects:x.of(!1)})},200)},N=R.StateEffect.define(),re=R.StateField.define({create(){return v.Decoration.none},update(e,r){try{for(let a of r.effects)if(a.is(N)){const s=a.value.map(c=>(c.context.locations||[]).map(({start:f,end:u})=>{const d=c.context.color||"#FFCA28";let i=r.newDoc.line(f.line).from+f.column,l=r.newDoc.line(u.line).from+u.column;const g=r.newDoc.length;return i>g||l>g?void 0:v.Decoration.mark({attributes:{style:`outline: 1.5px solid ${d};`}}).range(i,l)})).flat().filter(Boolean)||[];e=v.Decoration.set(s,!0)}return e}catch{return v.Decoration.set([])}},provide:e=>v.EditorView.decorations.from(e)}),oe=[G.javascript(),ee,re,te];function B({value:e,onChange:r,onViewChanged:a,onSelectionChange:s,options:c,editorDidMount:f}){const u=t.useCallback(l=>{r?.(l)},[r]),d=t.useCallback(l=>{a?.(l)},[a]),i=t.useCallback(l=>{l.selectionSet&&s&&s?.(l.state.selection)},[s]);return n.default.createElement(n.default.Fragment,null,n.default.createElement(Z.default,{value:e,onChange:u,onCreateEditor:d,onUpdate:i,extensions:oe}))}function P(...e){return e.filter(Boolean).join(" ")}function I({view:e,pattern:r,active:a,getTime:s}){const c=t.useRef([]),f=t.useRef();t.useEffect(()=>{if(e)if(r&&a){let d=function(){try{const i=s(),g=[Math.max(f.current||i,i-1/10,0),i+1/60];f.current=g[1],c.current=c.current.filter(m=>m.whole.end>i);const w=r.queryArc(...g).filter(m=>m.hasOnset());c.current=c.current.concat(w),e.dispatch({effects:N.of(c.current)})}catch{e.dispatch({effects:N.of([])})}u=requestAnimationFrame(d)},u=requestAnimationFrame(d);return()=>{cancelAnimationFrame(u)}}else c.current=[],e.dispatch({effects:N.of([])})},[r,a,e])}const ae="_container_3i85k_1",ne="_header_3i85k_5",se="_buttons_3i85k_9",ce="_button_3i85k_9",ie="_buttonDisabled_3i85k_17",le="_error_3i85k_21",ue="_body_3i85k_25",E={container:ae,header:ne,buttons:se,button:ce,buttonDisabled:ie,error:le,body:ue};function T({type:e}){return n.default.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",className:"sc-h-5 sc-w-5",viewBox:"0 0 20 20",fill:"currentColor"},{refresh:n.default.createElement("path",{fillRule:"evenodd",d:"M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z",clipRule:"evenodd"}),play:n.default.createElement("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z",clipRule:"evenodd"}),pause:n.default.createElement("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z",clipRule:"evenodd"})}[e])}function K({defaultOutput:e,interval:r,getTime:a,evalOnMount:s=!1,initialCode:c="",autolink:f=!1,beforeEval:u,afterEval:d,onEvalError:i}){const[l,g]=t.useState(),[w,m]=t.useState(),[b,D]=t.useState(c),[_,C]=t.useState(b),[q,F]=t.useState(),[k,M]=t.useState(!1),A=b!==_,{scheduler:y,evaluate:h,start:O,stop:U,pause:J}=t.useMemo(()=>X.repl({interval:r,defaultOutput:e,onSchedulerError:g,onEvalError:p=>{m(p),i?.(p)},getTime:a,transpiler:Y.transpiler,beforeEval:({code:p})=>{D(p),u?.()},afterEval:({pattern:p,code:L})=>{C(L),F(p),m(),g(),f&&(window.location.hash="#"+encodeURIComponent(btoa(L))),d?.()},onToggle:p=>M(p)}),[e,r,a]),S=t.useCallback(async(p=!0)=>h(b,p),[h,b]),H=t.useRef();return t.useEffect(()=>{!H.current&&s&&b&&(H.current=!0,S())},[S,s,b]),t.useEffect(()=>()=>{y.stop()},[y]),{code:b,setCode:D,error:l||w,schedulerError:l,scheduler:y,evalError:w,evaluate:h,activateCode:S,activeCode:_,isDirty:A,pattern:q,started:k,start:O,stop:U,pause:J,togglePlay:async()=>{k?y.pause():await S()}}}const de=()=>z.getAudioContext().currentTime;function fe({tune:e,hideOutsideView:r=!1,init:a,enableKeyboard:s}){const{code:c,setCode:f,evaluate:u,activateCode:d,error:i,isDirty:l,activeCode:g,pattern:w,started:m,scheduler:b,togglePlay:D,stop:_}=K({initialCode:e,defaultOutput:z.webaudioOutput,getTime:de}),[C,q]=t.useState(),[F,k]=W.useInView({threshold:.01}),M=t.useRef(),A=t.useMemo(()=>((k||!r)&&(M.current=!0),k||M.current),[k,r]);return I({view:C,pattern:w,active:m&&!g?.includes("strudel disable-highlighting"),getTime:()=>b.getPhase()}),t.useLayoutEffect(()=>{if(s){const y=async h=>{(h.ctrlKey||h.altKey)&&(h.code==="Enter"?(h.preventDefault(),j(C),await d()):h.code==="Period"&&(_(),h.preventDefault()))};return window.addEventListener("keydown",y,!0),()=>window.removeEventListener("keydown",y,!0)}},[s,w,c,u,_,C]),n.default.createElement("div",{className:E.container,ref:F},n.default.createElement("div",{className:E.header},n.default.createElement("div",{className:E.buttons},n.default.createElement("button",{className:P(E.button,m?"sc-animate-pulse":""),onClick:()=>D()},n.default.createElement(T,{type:m?"pause":"play"})),n.default.createElement("button",{className:P(l?E.button:E.buttonDisabled),onClick:()=>d()},n.default.createElement(T,{type:"refresh"}))),i&&n.default.createElement("div",{className:E.error},i.message)),n.default.createElement("div",{className:E.body},A&&n.default.createElement(B,{value:c,onChange:f,onViewChanged:q})))}function ge(e){return t.useEffect(()=>(window.addEventListener("message",e),()=>window.removeEventListener("message",e)),[e]),t.useCallback(r=>window.postMessage(r,"*"),[])}const me=e=>t.useLayoutEffect(()=>(window.addEventListener("keydown",e,!0),()=>window.removeEventListener("keydown",e,!0)),[e]);exports.CodeMirror=B;exports.MiniRepl=fe;exports.cx=P;exports.flash=j;exports.useHighlighting=I;exports.useKeydown=me;exports.usePostMessage=ge;exports.useStrudel=K;
