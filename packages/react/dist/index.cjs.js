"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});var t=require("react"),le=require("react-codemirror6"),k=require("@codemirror/view"),W=require("@codemirror/state"),ie=require("@codemirror/lang-javascript"),l=require("@codemirror/highlight"),ue=require("react-hook-inview"),de=require("@strudel.cycles/eval"),fe=require("@strudel.cycles/core/util.mjs"),h=require("@strudel.cycles/tone"),U=require("@strudel.cycles/core"),C=require("@strudel.cycles/midi");function ge(e){return e&&typeof e=="object"&&"default"in e?e:{default:e}}var d=ge(t);const me="#abb2bf",pe="#7d8799",be="#ffffff",he="#21252b",G="rgba(0, 0, 0, 0.5)",ve="transparent",j="#353a42",ye="rgba(128, 203, 196, 0.5)",O="#ffcc00",we=k.EditorView.theme({"&":{color:"#ffffff",backgroundColor:ve,fontSize:"15px","z-index":11},".cm-content":{caretColor:O,lineHeight:"22px"},".cm-line":{background:"transparent"},".cm-line > *":{background:"#00000090"},"&.cm-focused .cm-cursor":{backgroundColor:O,width:"3px"},"&.cm-focused .cm-selectionBackground, .cm-selectionBackground, .cm-content ::selection":{backgroundColor:ye},".cm-panels":{backgroundColor:he,color:"#ffffff"},".cm-panels.cm-panels-top":{borderBottom:"2px solid black"},".cm-panels.cm-panels-bottom":{borderTop:"2px solid black"},".cm-searchMatch":{backgroundColor:"#72a1ff59",outline:"1px solid #457dff"},".cm-searchMatch.cm-searchMatch-selected":{backgroundColor:"#6199ff2f"},".cm-activeLine":{backgroundColor:O+"50"},".cm-selectionMatch":{backgroundColor:"#aafe661a"},"&.cm-focused .cm-matchingBracket, &.cm-focused .cm-nonmatchingBracket":{backgroundColor:"#bad0f847",outline:"1px solid #515a6b"},".cm-gutters":{background:"transparent",color:"#676e95",border:"none"},".cm-activeLineGutter":{backgroundColor:G},".cm-foldPlaceholder":{backgroundColor:"transparent",border:"none",color:"#ddd"},".cm-tooltip":{border:"none",backgroundColor:j},".cm-tooltip .cm-tooltip-arrow:before":{borderTopColor:"transparent",borderBottomColor:"transparent"},".cm-tooltip .cm-tooltip-arrow:after":{borderTopColor:j,borderBottomColor:j},".cm-tooltip-autocomplete":{"& > ul > li[aria-selected]":{backgroundColor:G,color:me}}},{dark:!0}),Ce=l.HighlightStyle.define([{tag:l.tags.keyword,color:"#c792ea"},{tag:l.tags.operator,color:"#89ddff"},{tag:l.tags.special(l.tags.variableName),color:"#eeffff"},{tag:l.tags.typeName,color:"#f07178"},{tag:l.tags.atom,color:"#f78c6c"},{tag:l.tags.number,color:"#ff5370"},{tag:l.tags.definition(l.tags.variableName),color:"#82aaff"},{tag:l.tags.string,color:"#c3e88d"},{tag:l.tags.special(l.tags.string),color:"#f07178"},{tag:l.tags.comment,color:pe},{tag:l.tags.variableName,color:"#f07178"},{tag:l.tags.tagName,color:"#ff5370"},{tag:l.tags.bracket,color:"#a2a1a4"},{tag:l.tags.meta,color:"#ffcb6b"},{tag:l.tags.attributeName,color:"#c792ea"},{tag:l.tags.propertyName,color:"#c792ea"},{tag:l.tags.className,color:"#decb6b"},{tag:l.tags.invalid,color:be}]),ke=[we,Ce],$=W.StateEffect.define(),Me=W.StateField.define({create(){return k.Decoration.none},update(e,o){try{for(let n of o.effects)if(n.is($))if(n.value){const u=k.Decoration.mark({attributes:{style:"background-color: #FFCA2880"}});e=k.Decoration.set([u.range(0,o.newDoc.length)])}else e=k.Decoration.set([]);return e}catch(n){return console.warn("flash error",n),e}},provide:e=>k.EditorView.decorations.from(e)}),X=e=>{e.dispatch({effects:$.of(!0)}),setTimeout(()=>{e.dispatch({effects:$.of(!1)})},200)},P=W.StateEffect.define(),Ee=W.StateField.define({create(){return k.Decoration.none},update(e,o){try{for(let n of o.effects)n.is(P)&&(e=k.Decoration.set(n.value.flatMap(u=>(u.context.locations||[]).map(({start:g,end:i})=>{const c=u.context.color||"#FFCA28";let m=o.newDoc.line(g.line).from+g.column,a=o.newDoc.line(i.line).from+i.column;const r=o.newDoc.length;return m>r||a>r?void 0:k.Decoration.mark({attributes:{style:`outline: 1.5px solid ${c};`}}).range(m,a)})).filter(Boolean),!0));return e}catch{return e}},provide:e=>k.EditorView.decorations.from(e)});function Y({value:e,onChange:o,onViewChanged:n,onCursor:u,options:g,editorDidMount:i,theme:c}){return d.default.createElement(d.default.Fragment,null,d.default.createElement(le.CodeMirror,{onViewChange:n,style:{display:"flex",flexDirection:"column",flex:"1 0 auto"},value:e,onChange:o,extensions:[ie.javascript(),c||ke,Ee,Me]}))}function Z(e){const{onEvent:o,onQuery:n,onSchedule:u,ready:g=!0,onDraw:i}=e,[c,m]=t.useState(!1),a=1,r=()=>Math.floor(h.Tone.getTransport().seconds/a),T=(p=r())=>{const D=new U.TimeSpan(p,p+1),q=n?.(new U.State(D))||[];u?.(q,p);const H=D.begin.valueOf();h.Tone.getTransport().cancel(H);const w=(p+1)*a-.5,R=Math.max(h.Tone.getTransport().seconds,w)+.1;h.Tone.getTransport().schedule(()=>{T(p+1)},R),q?.filter(v=>v.part.begin.equals(v.whole?.begin)).forEach(v=>{h.Tone.getTransport().schedule(y=>{o(y,v,h.Tone.getContext().currentTime),h.Tone.Draw.schedule(()=>{i?.(y,v)},y)},v.part.begin.valueOf())})};t.useEffect(()=>{g&&T()},[o,u,n,i,g]);const x=async()=>{m(!0),await h.Tone.start(),h.Tone.getTransport().start("+0.1")},_=(p=!1)=>{p?(h.Tone.getTransport().cancel(),h.Tone.getTransport().stop()):h.Tone.getTransport().pause(),m(!1)};return{start:x,stop:_,onEvent:o,started:c,setStarted:m,toggle:()=>c?_():x(),query:T,activeCycle:r}}function ee(e){return t.useEffect(()=>(window.addEventListener("message",e),()=>window.removeEventListener("message",e)),[e]),t.useCallback(o=>window.postMessage(o,"*"),[])}let Te=()=>Math.floor((1+Math.random())*65536).toString(16).substring(1);const xe=e=>encodeURIComponent(btoa(e));function te({tune:e,defaultSynth:o,autolink:n=!0,onEvent:u,onDraw:g}){const i=t.useMemo(()=>Te(),[]),[c,m]=t.useState(e),[a,r]=t.useState(),[T,x]=t.useState(""),[_,S]=t.useState(),[p,D]=t.useState(!1),[q,H]=t.useState(""),[w,R]=t.useState(),v=t.useMemo(()=>c!==a||_,[c,a,_]),y=t.useCallback(f=>x(s=>s+`${s?`

`:""}${f}`),[]),F=t.useMemo(()=>{if(a&&!a.includes("strudel disable-highlighting"))return(f,s)=>g?.(f,s,a)},[a,g]),z=t.useMemo(()=>a&&a.includes("strudel hide-header"),[a]),L=t.useMemo(()=>a&&a.includes("strudel hide-console"),[a]),b=Z({onDraw:F,onEvent:t.useCallback((f,s,M)=>{try{u?.(f,s,M),s.context.logs?.length&&s.context.logs.forEach(y);const{onTrigger:N,velocity:se}=s.context;if(N)N(f,s,M,1);else if(o){const ce=fe.getPlayableNoteValue(s);o.triggerAttackRelease(ce,s.duration.valueOf(),f,se)}else if(!u)throw new Error("no defaultSynth nor onEvent passed to useRepl + event has no onTrigger. nothing happens")}catch(N){console.warn(N),N.message="unplayable event: "+N?.message,y(N.message)}},[u,y,o]),onQuery:t.useCallback(f=>{try{return w?.query(f)||[]}catch(s){return console.warn(s),s.message="query error: "+s.message,S(s),[]}},[w]),onSchedule:t.useCallback((f,s)=>ae(f,s),[]),ready:!!w&&!!a}),K=ee(({data:{from:f,type:s}})=>{s==="start"&&f!==i&&(b.setStarted(!1),r(void 0))}),A=t.useCallback(async(f=c,s=!1)=>{if(a&&!v){S(void 0),!s&&b.start();return}try{D(!0);const M=await de.evaluate(f);!s&&b.start(),K({type:"start",from:i}),R(()=>M.pattern),n&&(window.location.hash="#"+encodeURIComponent(btoa(c))),H(xe(c)),S(void 0),r(f),D(!1)}catch(M){M.message="evaluation error: "+M.message,console.warn(M),S(M)}},[a,v,c,b,n,i,K]),ae=(f,s)=>{f.length},re=()=>{b.started?b.stop():A()},Q=()=>{b.stop(!0),r(void 0)},ne=()=>{A(c,!0)};return t.useEffect(()=>()=>Q(),[]),{hideHeader:z,hideConsole:L,pending:p,code:c,setCode:m,pattern:w,error:_,cycle:b,setPattern:R,dirty:v,log:T,togglePlay:re,stop:Q,setActiveCode:r,activateCode:A,evaluateOnly:ne,activeCode:a,pushLog:y,hash:q}}function V(...e){return e.filter(Boolean).join(" ")}let B=[],J;function oe({view:e,pattern:o,active:n}){t.useEffect(()=>{if(e)if(o&&n){let g=function(){try{const i=h.Tone.getTransport().seconds,m=[Math.max(J||i,i-1/10),i+1/60];J=i+1/60,B=B.filter(r=>r.whole.end>i);const a=o.queryArc(...m).filter(r=>r.hasOnset());B=B.concat(a),e.dispatch({effects:P.of(B)})}catch{e.dispatch({effects:P.of([])})}u=requestAnimationFrame(g)},u=requestAnimationFrame(g);return()=>{cancelAnimationFrame(u)}}else B=[],e.dispatch({effects:P.of([])})},[o,n,e])}const _e="_container_10e1g_1",Se="_header_10e1g_5",De="_buttons_10e1g_9",Ne="_button_10e1g_9",qe="_buttonDisabled_10e1g_17",Re="_error_10e1g_21",Be="_body_10e1g_25";var E={container:_e,header:Se,buttons:De,button:Ne,buttonDisabled:qe,error:Re,body:Be};function I({type:e}){return d.default.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",className:"sc-h-5 sc-w-5",viewBox:"0 0 20 20",fill:"currentColor"},{refresh:d.default.createElement("path",{fillRule:"evenodd",d:"M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z",clipRule:"evenodd"}),play:d.default.createElement("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z",clipRule:"evenodd"}),pause:d.default.createElement("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z",clipRule:"evenodd"}),stop:d.default.createElement("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z",clipRule:"evenodd"})}[e])}function He({tune:e,defaultSynth:o,hideOutsideView:n=!1,theme:u,init:g,onEvent:i,enableKeyboard:c}){const{code:m,setCode:a,pattern:r,activeCode:T,activateCode:x,evaluateOnly:_,error:S,cycle:p,dirty:D,togglePlay:q,stop:H}=te({tune:e,defaultSynth:o,autolink:!1,onEvent:i});t.useEffect(()=>{g&&_()},[e,g]);const[w,R]=t.useState(),[v,y]=ue.useInView({threshold:.01}),F=t.useRef(),z=t.useMemo(()=>((y||!n)&&(F.current=!0),y||F.current),[y,n]);return oe({view:w,pattern:r,active:p.started&&!T?.includes("strudel disable-highlighting")}),t.useLayoutEffect(()=>{if(c){const L=async b=>{(b.ctrlKey||b.altKey)&&(b.code==="Enter"?(b.preventDefault(),X(w),await x()):b.code==="Period"&&(p.stop(),b.preventDefault()))};return window.addEventListener("keydown",L,!0),()=>window.removeEventListener("keydown",L,!0)}},[c,r,m,x,p,w]),d.default.createElement("div",{className:E.container,ref:v},d.default.createElement("div",{className:E.header},d.default.createElement("div",{className:E.buttons},d.default.createElement("button",{className:V(E.button,p.started?"sc-animate-pulse":""),onClick:()=>q()},d.default.createElement(I,{type:p.started?"pause":"play"})),d.default.createElement("button",{className:V(D?E.button:E.buttonDisabled),onClick:()=>x()},d.default.createElement(I,{type:"refresh"})),d.default.createElement("button",{className:V(E.button),onClick:()=>H(!0)},d.default.createElement(I,{type:"stop"}))),S&&d.default.createElement("div",{className:E.error},S.message)),d.default.createElement("div",{className:E.body},z&&d.default.createElement(Y,{theme:u,value:m,onChange:a,onViewChanged:R})))}function Fe(e){const{ready:o,connected:n,disconnected:u}=e,[g,i]=t.useState(!0),[c,m]=t.useState(C.WebMidi?.outputs||[]);return t.useEffect(()=>{C.enableWebMidi().then(()=>{C.WebMidi.addListener("connected",r=>{m([...C.WebMidi.outputs]),n?.(C.WebMidi,r)}),C.WebMidi.addListener("disconnected",r=>{m([...C.WebMidi.outputs]),u?.(C.WebMidi,r)}),o?.(C.WebMidi),i(!1)}).catch(r=>{if(r){console.error(r),console.warn("Web Midi could not be enabled..");return}})},[o,n,u,c]),{loading:g,outputs:c,outputByName:r=>C.WebMidi.getOutputByName(r)}}exports.CodeMirror=Y;exports.MiniRepl=He;exports.cx=V;exports.flash=X;exports.useCycle=Z;exports.useHighlighting=oe;exports.usePostMessage=ee;exports.useRepl=te;exports.useWebMidi=Fe;
