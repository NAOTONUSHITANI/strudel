"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});var t=require("react"),oe=require("@uiw/react-codemirror"),E=require("@codemirror/view"),L=require("@codemirror/state"),ne=require("@codemirror/lang-javascript"),i=require("@lezer/highlight"),se=require("@uiw/codemirror-themes"),ce=require("react-hook-inview"),le=require("@strudel.cycles/eval"),ie=require("@strudel.cycles/core/util.mjs"),y=require("@strudel.cycles/tone"),O=require("@strudel.cycles/core"),M=require("@strudel.cycles/midi");function K(e){return e&&typeof e=="object"&&"default"in e?e:{default:e}}var m=K(t),ue=K(oe),I=se.createTheme({theme:"dark",settings:{background:"#111",foreground:"#75baff",caret:"#ffcc00",selection:"rgba(128, 203, 196, 0.5)",selectionMatch:"#036dd626",lineHighlight:"#8a91991a",gutterBackground:"transparent",gutterForeground:"#676e95"},styles:[{tag:i.tags.keyword,color:"#c792ea"},{tag:i.tags.operator,color:"#89ddff"},{tag:i.tags.special(i.tags.variableName),color:"#eeffff"},{tag:i.tags.typeName,color:"#f07178"},{tag:i.tags.atom,color:"#f78c6c"},{tag:i.tags.number,color:"#ff5370"},{tag:i.tags.definition(i.tags.variableName),color:"#82aaff"},{tag:i.tags.string,color:"#c3e88d"},{tag:i.tags.special(i.tags.string),color:"#f07178"},{tag:i.tags.comment,color:"#7d8799"},{tag:i.tags.variableName,color:"#f07178"},{tag:i.tags.tagName,color:"#ff5370"},{tag:i.tags.bracket,color:"#a2a1a4"},{tag:i.tags.meta,color:"#ffcb6b"},{tag:i.tags.attributeName,color:"#c792ea"},{tag:i.tags.propertyName,color:"#c792ea"},{tag:i.tags.className,color:"#decb6b"},{tag:i.tags.invalid,color:"#ffffff"}]});const V=L.StateEffect.define(),de=L.StateField.define({create(){return E.Decoration.none},update(e,r){try{for(let n of r.effects)if(n.is(V))if(n.value){const u=E.Decoration.mark({attributes:{style:"background-color: #FFCA2880"}});e=E.Decoration.set([u.range(0,r.newDoc.length)])}else e=E.Decoration.set([]);return e}catch(n){return console.warn("flash error",n),e}},provide:e=>E.EditorView.decorations.from(e)}),Q=e=>{e.dispatch({effects:V.of(!0)}),setTimeout(()=>{e.dispatch({effects:V.of(!1)})},200)},A=L.StateEffect.define(),fe=L.StateField.define({create(){return E.Decoration.none},update(e,r){try{for(let n of r.effects)n.is(A)&&(e=E.Decoration.set(n.value.flatMap(u=>(u.context.locations||[]).map(({start:d,end:l})=>{const c=u.context.color||"#FFCA28";let f=r.newDoc.line(d.line).from+d.column,o=r.newDoc.line(l.line).from+l.column;const s=r.newDoc.length;return f>s||o>s?void 0:E.Decoration.mark({attributes:{style:`outline: 1.5px solid ${c};`}}).range(f,o)})).filter(Boolean),!0));return e}catch{return e}},provide:e=>E.EditorView.decorations.from(e)});function J({value:e,onChange:r,onViewChanged:n,onCursor:u,options:d,editorDidMount:l}){return console.log("coodemirrrorrr",I),m.default.createElement(m.default.Fragment,null,m.default.createElement(ue.default,{value:e,onChange:(c,f)=>{r(c)},onCreateEditor:c=>{n(c)},extensions:[ne.javascript(),I,fe,de]}))}function G(e){const{onEvent:r,onQuery:n,onSchedule:u,ready:d=!0,onDraw:l}=e,[c,f]=t.useState(!1),o=1,s=()=>Math.floor(y.Tone.getTransport().seconds/o),C=(p=s())=>{const D=new O.TimeSpan(p,p+1),q=n?.(new O.State(D))||[];u?.(q,p);const F=D.begin.valueOf();y.Tone.getTransport().cancel(F);const w=(p+1)*o-.5,N=Math.max(y.Tone.getTransport().seconds,w)+.1;y.Tone.getTransport().schedule(()=>{C(p+1)},N),q?.filter(b=>b.part.begin.equals(b.whole?.begin)).forEach(b=>{y.Tone.getTransport().schedule(v=>{r(v,b,y.Tone.getContext().currentTime),y.Tone.Draw.schedule(()=>{l?.(v,b)},v)},b.part.begin.valueOf())})};t.useEffect(()=>{d&&C()},[r,u,n,l,d]);const _=async()=>{f(!0),await y.Tone.start(),y.Tone.getTransport().start("+0.1")},T=()=>{y.Tone.getTransport().pause(),f(!1)};return{start:_,stop:T,onEvent:r,started:c,setStarted:f,toggle:()=>c?T():_(),query:C,activeCycle:s}}function X(e){return t.useEffect(()=>(window.addEventListener("message",e),()=>window.removeEventListener("message",e)),[e]),t.useCallback(r=>window.postMessage(r,"*"),[])}let ge=()=>Math.floor((1+Math.random())*65536).toString(16).substring(1);const me=e=>encodeURIComponent(btoa(e));function Y({tune:e,defaultSynth:r,autolink:n=!0,onEvent:u,onDraw:d}){const l=t.useMemo(()=>ge(),[]),[c,f]=t.useState(e),[o,s]=t.useState(),[C,_]=t.useState(""),[T,k]=t.useState(),[p,D]=t.useState(!1),[q,F]=t.useState(""),[w,N]=t.useState(),b=t.useMemo(()=>c!==o||T,[c,o,T]),v=t.useCallback(g=>_(a=>a+`${a?`

`:""}${g}`),[]),W=t.useMemo(()=>{if(o&&!o.includes("strudel disable-highlighting"))return(g,a)=>d?.(g,a,o)},[o,d]),P=t.useMemo(()=>o&&o.includes("strudel hide-header"),[o]),H=t.useMemo(()=>o&&o.includes("strudel hide-console"),[o]),h=G({onDraw:W,onEvent:t.useCallback((g,a,te)=>{try{u?.(a),a.context.logs?.length&&a.context.logs.forEach(v);const{onTrigger:S,velocity:ae}=a.context;if(S)S(g,a,te,1);else if(r){const re=ie.getPlayableNoteValue(a);r.triggerAttackRelease(re,a.duration.valueOf(),g,ae)}else throw new Error("no defaultSynth passed to useRepl.")}catch(S){console.warn(S),S.message="unplayable event: "+S?.message,v(S.message)}},[u,v,r]),onQuery:t.useCallback(g=>{try{return w?.query(g)||[]}catch(a){return console.warn(a),a.message="query error: "+a.message,k(a),[]}},[w]),onSchedule:t.useCallback((g,a)=>ee(g,a),[]),ready:!!w&&!!o}),j=X(({data:{from:g,type:a}})=>{a==="start"&&g!==l&&(h.setStarted(!1),s(void 0))}),B=t.useCallback(async(g=c)=>{if(o&&!b){k(void 0),h.start();return}try{D(!0);const a=await le.evaluate(g);h.start(),j({type:"start",from:l}),N(()=>a.pattern),n&&(window.location.hash="#"+encodeURIComponent(btoa(c))),F(me(c)),k(void 0),s(g),D(!1)}catch(a){a.message="evaluation error: "+a.message,console.warn(a),k(a)}},[o,b,c,h,n,l,j]),ee=(g,a)=>{g.length};return{hideHeader:P,hideConsole:H,pending:p,code:c,setCode:f,pattern:w,error:T,cycle:h,setPattern:N,dirty:b,log:C,togglePlay:()=>{h.started?h.stop():B()},setActiveCode:s,activateCode:B,activeCode:o,pushLog:v,hash:q}}function z(...e){return e.filter(Boolean).join(" ")}let R=[],U;function Z({view:e,pattern:r,active:n}){t.useEffect(()=>{if(e)if(r&&n){let d=function(){try{const l=y.Tone.getTransport().seconds,f=[Math.max(U||l,l-1/10),l+1/60];U=l+1/60,R=R.filter(s=>s.whole.end>l);const o=r.queryArc(...f).filter(s=>s.hasOnset());R=R.concat(o),e.dispatch({effects:A.of(R)})}catch{e.dispatch({effects:A.of([])})}u=requestAnimationFrame(d)},u=requestAnimationFrame(d);return()=>{cancelAnimationFrame(u)}}else R=[],e.dispatch({effects:A.of([])})},[r,n,e])}const he="_container_xpa19_1",pe="_header_xpa19_5",be="_buttons_xpa19_9",ve="_button_xpa19_9",ye="_buttonDisabled_xpa19_17",we="_error_xpa19_21",Me="_body_xpa19_25";var x={container:he,header:pe,buttons:be,button:ve,buttonDisabled:ye,error:we,body:Me};function $({type:e}){return m.default.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",className:"sc-h-5 sc-w-5",viewBox:"0 0 20 20",fill:"currentColor"},{refresh:m.default.createElement("path",{fillRule:"evenodd",d:"M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z",clipRule:"evenodd"}),play:m.default.createElement("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z",clipRule:"evenodd"}),pause:m.default.createElement("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z",clipRule:"evenodd"})}[e])}function Ee({tune:e,defaultSynth:r,hideOutsideView:n=!1,theme:u,init:d,onEvent:l,enableKeyboard:c}){const{code:f,setCode:o,pattern:s,activeCode:C,activateCode:_,evaluateOnly:T,error:k,cycle:p,dirty:D,togglePlay:q,stop:F}=Y({tune:e,defaultSynth:r,autolink:!1,onEvent:l});t.useEffect(()=>{d&&T()},[e,d]);const[w,N]=t.useState(),[b,v]=ce.useInView({threshold:.01}),W=t.useRef(),P=t.useMemo(()=>((v||!n)&&(W.current=!0),v||W.current),[v,n]);return Z({view:w,pattern:s,active:p.started&&!C?.includes("strudel disable-highlighting")}),t.useLayoutEffect(()=>{if(c){const H=async h=>{(h.ctrlKey||h.altKey)&&(h.code==="Enter"?(h.preventDefault(),Q(w),await _()):h.code==="Period"&&(p.stop(),h.preventDefault()))};return window.addEventListener("keydown",H,!0),()=>window.removeEventListener("keydown",H,!0)}},[c,s,f,_,p,w]),m.default.createElement("div",{className:x.container,ref:b},m.default.createElement("div",{className:x.header},m.default.createElement("div",{className:x.buttons},m.default.createElement("button",{className:z(x.button,p.started?"sc-animate-pulse":""),onClick:()=>q()},m.default.createElement($,{type:p.started?"pause":"play"})),m.default.createElement("button",{className:z(D?x.button:x.buttonDisabled),onClick:()=>_()},m.default.createElement($,{type:"refresh"}))),k&&m.default.createElement("div",{className:x.error},k.message)),m.default.createElement("div",{className:x.body},P&&m.default.createElement(J,{value:f,onChange:o,onViewChanged:N})))}function Ce(e){const{ready:r,connected:n,disconnected:u}=e,[d,l]=t.useState(!0),[c,f]=t.useState(M.WebMidi?.outputs||[]);return t.useEffect(()=>{M.enableWebMidi().then(()=>{M.WebMidi.addListener("connected",s=>{f([...M.WebMidi.outputs]),n?.(M.WebMidi,s)}),M.WebMidi.addListener("disconnected",s=>{f([...M.WebMidi.outputs]),u?.(M.WebMidi,s)}),r?.(M.WebMidi),l(!1)}).catch(s=>{if(s){console.error(s),console.warn("Web Midi could not be enabled..");return}})},[r,n,u,c]),{loading:d,outputs:c,outputByName:s=>M.WebMidi.getOutputByName(s)}}exports.CodeMirror=J;exports.MiniRepl=Ee;exports.cx=z;exports.flash=Q;exports.useCycle=G;exports.useHighlighting=Z;exports.usePostMessage=X;exports.useRepl=Y;exports.useWebMidi=Ce;
