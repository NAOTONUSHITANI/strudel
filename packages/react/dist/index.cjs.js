"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});var t=require("react"),oe=require("@uiw/react-codemirror"),E=require("@codemirror/view"),L=require("@codemirror/state"),re=require("@codemirror/lang-javascript"),u=require("@lezer/highlight"),se=require("@uiw/codemirror-themes"),ne=require("react-hook-inview"),ce=require("@strudel.cycles/eval"),le=require("@strudel.cycles/core/util.mjs"),y=require("@strudel.cycles/tone"),B=require("@strudel.cycles/core"),M=require("@strudel.cycles/midi");function $(e){return e&&typeof e=="object"&&"default"in e?e:{default:e}}var m=$(t),ie=$(oe),ue=se.createTheme({theme:"dark",settings:{background:"#222",foreground:"#75baff",caret:"#ffcc00",selection:"rgba(128, 203, 196, 0.5)",selectionMatch:"#036dd626",lineHighlight:"#8a91991a",gutterBackground:"transparent",gutterForeground:"#676e95"},styles:[{tag:u.tags.keyword,color:"#c792ea"},{tag:u.tags.operator,color:"#89ddff"},{tag:u.tags.special(u.tags.variableName),color:"#eeffff"},{tag:u.tags.typeName,color:"#f07178"},{tag:u.tags.atom,color:"#f78c6c"},{tag:u.tags.number,color:"#ff5370"},{tag:u.tags.definition(u.tags.variableName),color:"#82aaff"},{tag:u.tags.string,color:"#c3e88d"},{tag:u.tags.special(u.tags.string),color:"#f07178"},{tag:u.tags.comment,color:"#7d8799"},{tag:u.tags.variableName,color:"#f07178"},{tag:u.tags.tagName,color:"#ff5370"},{tag:u.tags.bracket,color:"#a2a1a4"},{tag:u.tags.meta,color:"#ffcb6b"},{tag:u.tags.attributeName,color:"#c792ea"},{tag:u.tags.propertyName,color:"#c792ea"},{tag:u.tags.className,color:"#decb6b"},{tag:u.tags.invalid,color:"#ffffff"}]});const P=L.StateEffect.define(),de=L.StateField.define({create(){return E.Decoration.none},update(e,o){try{for(let n of o.effects)if(n.is(P))if(n.value){const c=E.Decoration.mark({attributes:{style:"background-color: #FFCA2880"}});e=E.Decoration.set([c.range(0,o.newDoc.length)])}else e=E.Decoration.set([]);return e}catch(n){return console.warn("flash error",n),e}},provide:e=>E.EditorView.decorations.from(e)}),K=e=>{e.dispatch({effects:P.of(!0)}),setTimeout(()=>{e.dispatch({effects:P.of(!1)})},200)},A=L.StateEffect.define(),fe=L.StateField.define({create(){return E.Decoration.none},update(e,o){try{for(let n of o.effects)n.is(A)&&(e=E.Decoration.set(n.value.flatMap(c=>(c.context.locations||[]).map(({start:f,end:l})=>{const i=c.context.color||"#FFCA28";let d=o.newDoc.line(f.line).from+f.column,r=o.newDoc.line(l.line).from+l.column;const a=o.newDoc.length;return d>a||r>a?void 0:E.Decoration.mark({attributes:{style:`outline: 1.5px solid ${i};`}}).range(d,r)})).filter(Boolean),!0));return e}catch{return e}},provide:e=>E.EditorView.decorations.from(e)}),ge=[re.javascript(),ue,fe,de];function Q({value:e,onChange:o,onViewChanged:n,onSelectionChange:c,options:f,editorDidMount:l}){const i=t.useCallback(a=>{o?.(a)},[o]),d=t.useCallback(a=>{n?.(a)},[n]),r=t.useCallback(a=>{a.selectionSet&&c&&c?.(a.state.selection)},[c]);return m.default.createElement(m.default.Fragment,null,m.default.createElement(ie.default,{value:e,onChange:i,onCreateEditor:d,onUpdate:r,extensions:ge}))}function J(e){const{onEvent:o,onQuery:n,onSchedule:c,ready:f=!0,onDraw:l}=e,[i,d]=t.useState(!1),r=1,a=()=>Math.floor(y.Tone.getTransport().seconds/r),C=(p=a())=>{const S=new B.TimeSpan(p,p+1),N=n?.(new B.State(S))||[];c?.(N,p);const F=S.begin.valueOf();y.Tone.getTransport().cancel(F);const w=(p+1)*r-.5,R=Math.max(y.Tone.getTransport().seconds,w)+.1;y.Tone.getTransport().schedule(()=>{C(p+1)},R),N?.filter(b=>b.part.begin.equals(b.whole?.begin)).forEach(b=>{y.Tone.getTransport().schedule(v=>{o(v,b,y.Tone.getContext().currentTime),y.Tone.Draw.schedule(()=>{l?.(v,b)},v)},b.part.begin.valueOf())})};t.useEffect(()=>{f&&C()},[o,c,n,l,f]);const k=async()=>{d(!0),await y.Tone.start(),y.Tone.getTransport().start("+0.1")},_=()=>{y.Tone.getTransport().pause(),d(!1)};return{start:k,stop:_,onEvent:o,started:i,setStarted:d,toggle:()=>i?_():k(),query:C,activeCycle:a}}function G(e){return t.useEffect(()=>(window.addEventListener("message",e),()=>window.removeEventListener("message",e)),[e]),t.useCallback(o=>window.postMessage(o,"*"),[])}let me=()=>Math.floor((1+Math.random())*65536).toString(16).substring(1);const he=e=>encodeURIComponent(btoa(e));function X({tune:e,defaultSynth:o,autolink:n=!0,onEvent:c,onDraw:f}){const l=t.useMemo(()=>me(),[]),[i,d]=t.useState(e),[r,a]=t.useState(),[C,k]=t.useState(""),[_,T]=t.useState(),[p,S]=t.useState(!1),[N,F]=t.useState(""),[w,R]=t.useState(),b=t.useMemo(()=>i!==r||_,[i,r,_]),v=t.useCallback(g=>k(s=>s+`${s?`

`:""}${g}`),[]),W=t.useMemo(()=>{if(r&&!r.includes("strudel disable-highlighting"))return(g,s)=>f?.(g,s,r)},[r,f]),O=t.useMemo(()=>r&&r.includes("strudel hide-header"),[r]),H=t.useMemo(()=>r&&r.includes("strudel hide-console"),[r]),h=J({onDraw:W,onEvent:t.useCallback((g,s,ee)=>{try{c?.(s),s.context.logs?.length&&s.context.logs.forEach(v);const{onTrigger:q,velocity:te}=s.context;if(q)q(g,s,ee,1);else if(o){const ae=le.getPlayableNoteValue(s);o.triggerAttackRelease(ae,s.duration.valueOf(),g,te)}else throw new Error("no defaultSynth passed to useRepl.")}catch(q){console.warn(q),q.message="unplayable event: "+q?.message,v(q.message)}},[c,v,o]),onQuery:t.useCallback(g=>{try{return w?.query(g)||[]}catch(s){return console.warn(s),s.message="query error: "+s.message,T(s),[]}},[w]),onSchedule:t.useCallback((g,s)=>Z(g),[]),ready:!!w&&!!r}),z=G(({data:{from:g,type:s}})=>{s==="start"&&g!==l&&(h.setStarted(!1),a(void 0))}),j=t.useCallback(async(g=i)=>{if(r&&!b){T(void 0),h.start();return}try{S(!0);const s=await ce.evaluate(g);h.start(),z({type:"start",from:l}),R(()=>s.pattern),n&&(window.location.hash="#"+encodeURIComponent(btoa(i))),F(he(i)),T(void 0),a(g),S(!1)}catch(s){s.message="evaluation error: "+s.message,console.warn(s),T(s)}},[r,b,i,h,n,l,z]),Z=(g,s)=>{g.length};return{hideHeader:O,hideConsole:H,pending:p,code:i,setCode:d,pattern:w,error:_,cycle:h,setPattern:R,dirty:b,log:C,togglePlay:()=>{h.started?h.stop():j()},setActiveCode:a,activateCode:j,activeCode:r,pushLog:v,hash:N}}function V(...e){return e.filter(Boolean).join(" ")}let x=[],I;function Y({view:e,pattern:o,active:n}){t.useEffect(()=>{if(e)if(o&&n){let f=function(){try{const l=y.Tone.getTransport().seconds,d=[Math.max(I||l,l-1/10),l+1/60];I=l+1/60,x=x.filter(a=>a.whole.end>l);const r=o.queryArc(...d).filter(a=>a.hasOnset());x=x.concat(r),console.log("update...",e.state.doc.length),e.dispatch({effects:A.of(x)})}catch{e.dispatch({effects:A.of([])})}c=requestAnimationFrame(f)},c=requestAnimationFrame(f);return()=>{cancelAnimationFrame(c)}}else x=[],e.dispatch({effects:A.of([])})},[o,n,e])}const pe="_container_3i85k_1",be="_header_3i85k_5",ve="_buttons_3i85k_9",ye="_button_3i85k_9",we="_buttonDisabled_3i85k_17",Me="_error_3i85k_21",Ee="_body_3i85k_25";var D={container:pe,header:be,buttons:ve,button:ye,buttonDisabled:we,error:Me,body:Ee};function U({type:e}){return m.default.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",className:"sc-h-5 sc-w-5",viewBox:"0 0 20 20",fill:"currentColor"},{refresh:m.default.createElement("path",{fillRule:"evenodd",d:"M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z",clipRule:"evenodd"}),play:m.default.createElement("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z",clipRule:"evenodd"}),pause:m.default.createElement("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z",clipRule:"evenodd"})}[e])}function Ce({tune:e,defaultSynth:o,hideOutsideView:n=!1,theme:c,init:f,onEvent:l,enableKeyboard:i}){const{code:d,setCode:r,pattern:a,activeCode:C,activateCode:k,evaluateOnly:_,error:T,cycle:p,dirty:S,togglePlay:N,stop:F}=X({tune:e,defaultSynth:o,autolink:!1,onEvent:l});t.useEffect(()=>{f&&_()},[e,f]);const[w,R]=t.useState(),[b,v]=ne.useInView({threshold:.01}),W=t.useRef(),O=t.useMemo(()=>((v||!n)&&(W.current=!0),v||W.current),[v,n]);return Y({view:w,pattern:a,active:p.started&&!C?.includes("strudel disable-highlighting")}),t.useLayoutEffect(()=>{if(i){const H=async h=>{(h.ctrlKey||h.altKey)&&(h.code==="Enter"?(h.preventDefault(),K(w),await k()):h.code==="Period"&&(p.stop(),h.preventDefault()))};return window.addEventListener("keydown",H,!0),()=>window.removeEventListener("keydown",H,!0)}},[i,a,d,k,p,w]),m.default.createElement("div",{className:D.container,ref:b},m.default.createElement("div",{className:D.header},m.default.createElement("div",{className:D.buttons},m.default.createElement("button",{className:V(D.button,p.started?"sc-animate-pulse":""),onClick:()=>N()},m.default.createElement(U,{type:p.started?"pause":"play"})),m.default.createElement("button",{className:V(S?D.button:D.buttonDisabled),onClick:()=>k()},m.default.createElement(U,{type:"refresh"}))),T&&m.default.createElement("div",{className:D.error},T.message)),m.default.createElement("div",{className:D.body},O&&m.default.createElement(Q,{value:d,onChange:r,onViewChanged:R})))}function ke(e){const{ready:o,connected:n,disconnected:c}=e,[f,l]=t.useState(!0),[i,d]=t.useState(M.WebMidi?.outputs||[]);return t.useEffect(()=>{M.enableWebMidi().then(()=>{M.WebMidi.addListener("connected",a=>{d([...M.WebMidi.outputs]),n?.(M.WebMidi,a)}),M.WebMidi.addListener("disconnected",a=>{d([...M.WebMidi.outputs]),c?.(M.WebMidi,a)}),o?.(M.WebMidi),l(!1)}).catch(a=>{if(a){console.error(a),console.warn("Web Midi could not be enabled..");return}})},[o,n,c,i]),{loading:f,outputs:i,outputByName:a=>M.WebMidi.getOutputByName(a)}}exports.CodeMirror=Q;exports.MiniRepl=Ce;exports.cx=V;exports.flash=K;exports.useCycle=J;exports.useHighlighting=Y;exports.usePostMessage=G;exports.useRepl=X;exports.useWebMidi=ke;
