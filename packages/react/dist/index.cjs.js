"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});var t=require("react"),oe=require("@uiw/react-codemirror"),k=require("@codemirror/view"),H=require("@codemirror/state"),se=require("@codemirror/lang-javascript"),d=require("@lezer/highlight"),ne=require("@uiw/codemirror-themes"),ce=require("react-hook-inview"),U=require("@strudel.cycles/eval"),ie=require("@strudel.cycles/core/util.mjs"),E=require("@strudel.cycles/tone"),V=require("@strudel.cycles/core"),C=require("@strudel.cycles/midi");function $(e){return e&&typeof e=="object"&&"default"in e?e:{default:e}}var m=$(t),le=$(oe),ue=ne.createTheme({theme:"dark",settings:{background:"#222",foreground:"#75baff",caret:"#ffcc00",selection:"rgba(128, 203, 196, 0.5)",selectionMatch:"#036dd626",lineHighlight:"#8a91991a",gutterBackground:"transparent",gutterForeground:"#676e95"},styles:[{tag:d.tags.keyword,color:"#c792ea"},{tag:d.tags.operator,color:"#89ddff"},{tag:d.tags.special(d.tags.variableName),color:"#eeffff"},{tag:d.tags.typeName,color:"#f07178"},{tag:d.tags.atom,color:"#f78c6c"},{tag:d.tags.number,color:"#ff5370"},{tag:d.tags.definition(d.tags.variableName),color:"#82aaff"},{tag:d.tags.string,color:"#c3e88d"},{tag:d.tags.special(d.tags.string),color:"#f07178"},{tag:d.tags.comment,color:"#7d8799"},{tag:d.tags.variableName,color:"#f07178"},{tag:d.tags.tagName,color:"#ff5370"},{tag:d.tags.bracket,color:"#a2a1a4"},{tag:d.tags.meta,color:"#ffcb6b"},{tag:d.tags.attributeName,color:"#c792ea"},{tag:d.tags.propertyName,color:"#c792ea"},{tag:d.tags.className,color:"#decb6b"},{tag:d.tags.invalid,color:"#ffffff"}]});const z=H.StateEffect.define(),de=H.StateField.define({create(){return k.Decoration.none},update(e,a){try{for(let o of a.effects)if(o.is(z))if(o.value){const i=k.Decoration.mark({attributes:{style:"background-color: #FFCA2880"}});e=k.Decoration.set([i.range(0,a.newDoc.length)])}else e=k.Decoration.set([]);return e}catch(o){return console.warn("flash error",o),e}},provide:e=>k.EditorView.decorations.from(e)}),Q=e=>{e.dispatch({effects:z.of(!0)}),setTimeout(()=>{e.dispatch({effects:z.of(!1)})},200)},A=H.StateEffect.define(),fe=H.StateField.define({create(){return k.Decoration.none},update(e,a){try{for(let o of a.effects)if(o.is(A)){const i=o.value.map(u=>(u.context.locations||[]).map(({start:c,end:l})=>{const f=u.context.color||"#FFCA28";let s=a.newDoc.line(c.line).from+c.column,r=a.newDoc.line(l.line).from+l.column;const b=a.newDoc.length;return s>b||r>b?void 0:k.Decoration.mark({attributes:{style:`outline: 1.5px solid ${f};`}}).range(s,r)})).flat().filter(Boolean)||[];e=k.Decoration.set(i,!0)}return e}catch{return k.Decoration.set([])}},provide:e=>k.EditorView.decorations.from(e)}),ge=[se.javascript(),ue,fe,de];function J({value:e,onChange:a,onViewChanged:o,onSelectionChange:i,options:u,editorDidMount:c}){const l=t.useCallback(r=>{a?.(r)},[a]),f=t.useCallback(r=>{o?.(r)},[o]),s=t.useCallback(r=>{r.selectionSet&&i&&i?.(r.state.selection)},[i]);return m.default.createElement(m.default.Fragment,null,m.default.createElement(le.default,{value:e,onChange:l,onCreateEditor:f,onUpdate:s,extensions:ge}))}function G(e){const{onEvent:a,onQuery:o,onSchedule:i,ready:u=!0,onDraw:c}=e,[l,f]=t.useState(!1),s=1,r=()=>Math.floor(E.Tone.getTransport().seconds/s),b=(v=r())=>{const D=new V.TimeSpan(v,v+1),N=o?.(new V.State(D))||[];i?.(N,v);const F=D.begin.valueOf();E.Tone.getTransport().cancel(F);const M=(v+1)*s-.5,R=Math.max(E.Tone.getTransport().seconds,M)+.1;E.Tone.getTransport().schedule(()=>{b(v+1)},R),N?.filter(y=>y.part.begin.equals(y.whole?.begin)).forEach(y=>{E.Tone.getTransport().schedule(w=>{a(w,y,E.Tone.getContext().currentTime),E.Tone.Draw.schedule(()=>{c?.(w,y)},w)},y.part.begin.valueOf())})};t.useEffect(()=>{u&&b()},[a,i,o,c,u]);const h=async()=>{f(!0),await E.Tone.start(),E.Tone.getTransport().start("+0.1")},_=()=>{E.Tone.getTransport().pause(),f(!1)};return{start:h,stop:_,onEvent:a,started:l,setStarted:f,toggle:()=>l?_():h(),query:b,activeCycle:r}}function X(e){return t.useEffect(()=>(window.addEventListener("message",e),()=>window.removeEventListener("message",e)),[e]),t.useCallback(a=>window.postMessage(a,"*"),[])}let me=()=>Math.floor((1+Math.random())*65536).toString(16).substring(1);const he=e=>encodeURIComponent(btoa(e));function Y({tune:e,defaultSynth:a,autolink:o=!0,onEvent:i,onDraw:u}){const c=t.useMemo(()=>me(),[]),[l,f]=t.useState(e),[s,r]=t.useState(),[b,h]=t.useState(""),[_,T]=t.useState(),[v,D]=t.useState(!1),[N,F]=t.useState(""),[M,R]=t.useState(),y=t.useMemo(()=>l!==s||_,[l,s,_]),w=t.useCallback(g=>h(n=>n+`${n?`

`:""}${g}`),[]),L=t.useMemo(()=>{if(s&&!s.includes("strudel disable-highlighting"))return(g,n)=>u?.(g,n,s)},[s,u]),P=t.useMemo(()=>s&&s.includes("strudel hide-header"),[s]),W=t.useMemo(()=>s&&s.includes("strudel hide-console"),[s]),p=G({onDraw:L,onEvent:t.useCallback((g,n,te)=>{try{i?.(n),n.context.logs?.length&&n.context.logs.forEach(w);const{onTrigger:q,velocity:re}=n.context;if(q)q(g,n,te,1);else if(a){const ae=ie.getPlayableNoteValue(n);a.triggerAttackRelease(ae,n.duration.valueOf(),g,re)}else throw new Error("no defaultSynth passed to useRepl.")}catch(q){console.warn(q),q.message="unplayable event: "+q?.message,w(q.message)}},[i,w,a]),onQuery:t.useCallback(g=>{try{return M?.query(g)||[]}catch(n){return console.warn(n),n.message="query error: "+n.message,T(n),[]}},[M]),onSchedule:t.useCallback((g,n)=>ee(g),[]),ready:!!M&&!!s}),j=X(({data:{from:g,type:n}})=>{n==="start"&&g!==c&&(p.setStarted(!1),r(void 0))}),B=t.useCallback(async(g=l)=>{if(s&&!y){T(void 0),p.start();return}try{D(!0);const n=await U.evaluate(g);p.start(),j({type:"start",from:c}),R(()=>n.pattern),o&&(window.location.hash="#"+encodeURIComponent(btoa(l))),F(he(l)),T(void 0),r(g),D(!1)}catch(n){n.message="evaluation error: "+n.message,console.warn(n),T(n)}},[s,y,l,p,o,c,j]),ee=(g,n)=>{g.length};return{hideHeader:P,hideConsole:W,pending:v,code:l,setCode:f,pattern:M,error:_,cycle:p,setPattern:R,dirty:y,log:b,togglePlay:()=>{p.started?p.stop():B()},setActiveCode:r,activateCode:B,activeCode:s,pushLog:w,hash:N}}function O(...e){return e.filter(Boolean).join(" ")}let x=[],I;function Z({view:e,pattern:a,active:o}){t.useEffect(()=>{if(e)if(a&&o){let u=function(){try{const c=E.Tone.getTransport().seconds,f=[Math.max(I||c,c-1/10),c+1/60];I=c+1/60,x=x.filter(r=>r.whole.end>c);const s=a.queryArc(...f).filter(r=>r.hasOnset());x=x.concat(s),e.dispatch({effects:A.of(x)})}catch{e.dispatch({effects:A.of([])})}i=requestAnimationFrame(u)},i=requestAnimationFrame(u);return()=>{cancelAnimationFrame(i)}}else x=[],e.dispatch({effects:A.of([])})},[a,o,e])}const pe="_container_3i85k_1",be="_header_3i85k_5",ve="_buttons_3i85k_9",ye="_button_3i85k_9",we="_buttonDisabled_3i85k_17",Ee="_error_3i85k_21",Me="_body_3i85k_25";var S={container:pe,header:be,buttons:ve,button:ye,buttonDisabled:we,error:Ee,body:Me};function K({type:e}){return m.default.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",className:"sc-h-5 sc-w-5",viewBox:"0 0 20 20",fill:"currentColor"},{refresh:m.default.createElement("path",{fillRule:"evenodd",d:"M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z",clipRule:"evenodd"}),play:m.default.createElement("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z",clipRule:"evenodd"}),pause:m.default.createElement("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z",clipRule:"evenodd"})}[e])}function Ce({tune:e,defaultSynth:a,hideOutsideView:o=!1,theme:i,init:u,onEvent:c,enableKeyboard:l}){const{code:f,setCode:s,pattern:r,activeCode:b,activateCode:h,evaluateOnly:_,error:T,cycle:v,dirty:D,togglePlay:N,stop:F}=Y({tune:e,defaultSynth:a,autolink:!1,onEvent:c});t.useEffect(()=>{u&&_()},[e,u]);const[M,R]=t.useState(),[y,w]=ce.useInView({threshold:.01}),L=t.useRef(),P=t.useMemo(()=>((w||!o)&&(L.current=!0),w||L.current),[w,o]);return Z({view:M,pattern:r,active:v.started&&!b?.includes("strudel disable-highlighting")}),t.useLayoutEffect(()=>{if(l){const W=async p=>{(p.ctrlKey||p.altKey)&&(p.code==="Enter"?(p.preventDefault(),Q(M),await h()):p.code==="Period"&&(v.stop(),p.preventDefault()))};return window.addEventListener("keydown",W,!0),()=>window.removeEventListener("keydown",W,!0)}},[l,r,f,h,v,M]),m.default.createElement("div",{className:S.container,ref:y},m.default.createElement("div",{className:S.header},m.default.createElement("div",{className:S.buttons},m.default.createElement("button",{className:O(S.button,v.started?"sc-animate-pulse":""),onClick:()=>N()},m.default.createElement(K,{type:v.started?"pause":"play"})),m.default.createElement("button",{className:O(D?S.button:S.buttonDisabled),onClick:()=>h()},m.default.createElement(K,{type:"refresh"}))),T&&m.default.createElement("div",{className:S.error},T.message)),m.default.createElement("div",{className:S.body},P&&m.default.createElement(J,{value:f,onChange:s,onViewChanged:R})))}function ke(e,a,o=.1){const[i,u]=t.useState(),c=t.useMemo(()=>new V.Scheduler({interval:o,onTrigger:a,onError:u}),[a,o]);return t.useEffect(()=>{e&&c?.setPattern(e)},[e,c]),{error:i,scheduler:c}}function _e({code:e,evalOnMount:a=!0}){const[o,i]=t.useState(),[u,c]=t.useState(e),[l,f]=t.useState(),s=e!==u,r=t.useCallback(async()=>{if(!e){console.log("no code..");return}try{const{pattern:h}=await U.evaluate(e);c(e),f(h),i()}catch(h){i(h),console.warn("eval error",h)}},[e,scheduler]),b=t.useRef();return t.useEffect(()=>{!b.current&&a&&(b.current=!0,r())},[r,a]),{error:o,evaluate:r,activeCode:u,pattern:l,isDirty:s}}const Te=e=>t.useLayoutEffect(()=>(window.addEventListener("keydown",e,!0),()=>window.removeEventListener("keydown",e,!0)),[e]);function Se(e){const{ready:a,connected:o,disconnected:i}=e,[u,c]=t.useState(!0),[l,f]=t.useState(C.WebMidi?.outputs||[]);return t.useEffect(()=>{C.enableWebMidi().then(()=>{C.WebMidi.addListener("connected",r=>{f([...C.WebMidi.outputs]),o?.(C.WebMidi,r)}),C.WebMidi.addListener("disconnected",r=>{f([...C.WebMidi.outputs]),i?.(C.WebMidi,r)}),a?.(C.WebMidi),c(!1)}).catch(r=>{if(r){console.error(r),console.warn("Web Midi could not be enabled..");return}})},[a,o,i,l]),{loading:u,outputs:l,outputByName:r=>C.WebMidi.getOutputByName(r)}}exports.CodeMirror=J;exports.MiniRepl=Ce;exports.cx=O;exports.flash=Q;exports.useCycle=G;exports.useEvaluator=_e;exports.useHighlighting=Z;exports.useKeydown=Te;exports.usePostMessage=X;exports.useRepl=Y;exports.useScheduler=ke;exports.useWebMidi=Se;
