<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Strudel AI Prototye with History</title>
  <style>
    /* ãƒšãƒ¼ã‚¸å…¨ä½“ãƒªã‚»ãƒƒãƒˆ */
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }

    /* Strudelã‚¨ãƒ‡ã‚£ã‚¿ã® iframe ã‚³ãƒ³ãƒ†ãƒŠ */
    .iframe-container {
      width: 100%;
      height: 100vh;
      position: relative;
    }

    .iframe-container iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    
    /* --- å³ä¸‹ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒœã‚¿ãƒ³ã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ« --- */
    .global-button {
      position: fixed;
      bottom: 20px;
      background: #6c757d;
      color: white;
      border: none;
      font-size: 20px;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      cursor: pointer;
      z-index: 1000;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #chatToggleButton { right: 20px; background: #007bff; }
    #codeTemplateButton { right: 80px; }
    #historyButton { right: 140px; }


    /* --- ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
    .chat-box {
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 340px;
      height: 450px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 10px;
      display: none;
      flex-direction: column;
      z-index: 999;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      overflow: hidden;
    }
    .chat-messages { flex: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
    .chat-bubble { max-width: 80%; padding: 10px 14px; border-radius: 12px; word-wrap: break-word; line-height: 1.5; white-space: pre-wrap; font-size: 14px; }
    .chat-bubble.user { background-color: #dcf8c6; align-self: flex-end; }
    .chat-bubble.ai { background-color: #f0f0f0; align-self: flex-start; }
    .chat-input-area { display: flex; padding: 10px; border-top: 1px solid #ccc; background: #f8f8f8; }
    .chat-input-area input { flex: 1; padding: 8px 12px; border-radius: 10px; border: 1px solid #ccc; font-size: 14px; }
    .chat-input-area button { margin-left: 10px; padding: 0 16px; border-radius: 10px; border: none; background: #007bff; color: white; font-size: 16px; cursor: pointer; }

    /* --- ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ« --- */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }
    .modal-container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 700px;
      position: relative;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .modal-close-btn {
      position: absolute;
      top: 10px; right: 15px;
      background: none; border: none;
      font-size: 28px; cursor: pointer; color: #aaa;
    }
    .modal-close-btn:hover { color: #333; }
    .copy-code-btn {
      padding: 5px 10px;
      background: #6c757d; color: white;
      border: none; border-radius: 5px; cursor: pointer;
    }

    /* --- ã‚³ãƒ¼ãƒ‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ©Ÿèƒ½ã®å›ºæœ‰ã‚¹ã‚¿ã‚¤ãƒ« --- */
    .template-content { display: flex; margin-top: 15px; gap: 20px; }
    .genre-list { display: flex; flex-direction: column; gap: 10px; flex-shrink: 0; }
    .genre-list button { padding: 8px 12px; border: 1px solid #ccc; border-radius: 5px; background: #f0f0f0; cursor: pointer; text-align: left; }
    .genre-list button.active { background: #007bff; color: white; border-color: #007bff; }
    .code-viewer { flex-grow: 1; position: relative; }
    .code-viewer pre { background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 5px; white-space: pre-wrap; word-wrap: break-word; height: 300px; max-height: 50vh; overflow-y: auto; margin: 0; font-size: 14px; }
    .code-viewer .copy-code-btn { position: absolute; top: 10px; right: 10px; }
    
    /* --- å±¥æ­´æ©Ÿèƒ½ã®å›ºæœ‰ã‚¹ã‚¿ã‚¤ãƒ« --- */
    .history-list { margin-top: 15px; max-height: 60vh; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
    .history-item { position: relative; border: 1px solid #ddd; border-radius: 5px; }
    .history-item pre { background: #2d2d2d; color: #f8f8f2; padding: 15px; padding-top: 40px; border-radius: 5px; margin: 0; white-space: pre-wrap; word-wrap: break-word; font-size: 14px; }
    .history-item .copy-code-btn { position: absolute; top: 8px; right: 8px; }

  </style>
</head>
<body>

  <div class="iframe-container">
    <iframe src="https://strudel.tidalcycles.org" frameborder="0"></iframe>
  </div>

  <button id="chatToggleButton" class="global-button" title="AIãƒãƒ£ãƒƒãƒˆ">ğŸ’¬</button>
  <button id="codeTemplateButton" class="global-button" title="ã‚³ãƒ¼ãƒ‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ">ğŸµ</button>
  <button id="historyButton" class="global-button" title="ç”Ÿæˆå±¥æ­´">ğŸ•’</button>

  <div id="chatBox" class="chat-box">
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input-area">
      <input type="text" id="chatInput" placeholder="AIã«è³ªå•..." />
      <button id="sendButton">â¬†ï¸</button>
    </div>
  </div>

  <div id="templateModalOverlay" class="modal-overlay">
    <div class="modal-container">
      <button id="templateModalCloseButton" class="modal-close-btn">&times;</button>
      <h2>ã‚³ãƒ¼ãƒ‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</h2>
      <div class="template-content">
        <div id="genreList" class="genre-list"></div>
        <div class="code-viewer">
          <pre><code id="codeDisplay"></code></pre>
          <button id="templateCopyCodeButton" class="copy-code-btn">ã‚³ãƒ”ãƒ¼</button>
        </div>
      </div>
    </div>
  </div>

  <div id="historyModalOverlay" class="modal-overlay">
    <div class="modal-container">
      <button id="historyModalCloseButton" class="modal-close-btn">&times;</button>
      <h2>ç”Ÿæˆå±¥æ­´</h2>
      <div id="historyList" class="history-list"></div>
    </div>
  </div>

  <script>
    // --- ãƒ‡ãƒ¼ã‚¿å®šç¾© ---
    const OPENAI_API_KEY = "";
    const strudelAssistantPrompt = `ã‚ãªãŸã¯Strudelã¨ã„ã†Webãƒ™ãƒ¼ã‚¹ã®ãƒ©ã‚¤ãƒ–ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç’°å¢ƒã«ç‰¹åŒ–ã—ãŸAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŒ‡ç¤ºã«å¿œã˜ã¦ã€æ­£ã—ã„Strudelã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚ã‚³ãƒ¼ãƒ‰ã«ã¯å¯èƒ½ãªé™ã‚Šæ—¥æœ¬èªã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ã¤ã‘ã¦ãã ã•ã„ã€‚`;
    const codeTemplates = [
      { title: "ãƒ•ã‚¡ãƒ³ã‚¯", code: `// ãƒ•ã‚¡ãƒ³ã‚­ãƒ¼ãª16ãƒ“ãƒ¼ãƒˆãƒ‰ãƒ©ãƒ \np1: s("bd ~ sd ~ bd bd sd ~").every(2, p => p.add(0.1)).swing(0.1).bank("drumkit"),\n// ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³\np2: n("0 0 3 5 0 0 3 0").add(-24).s("bass").gain(0.9),\n// ã‚«ãƒƒãƒ†ã‚£ãƒ³ã‚°ã‚®ã‚¿ãƒ¼\np3: s("~ [~ cp] ~ cp").every(4, rev).gain(0.8)` },
      { title: "ãƒ†ã‚¯ãƒ", code: `// 4ã¤æ‰“ã¡ã®ã‚­ãƒƒã‚¯ã¨ã‚ªãƒ•ãƒ“ãƒ¼ãƒˆãƒã‚¤ãƒãƒƒãƒˆ\np1: s("bd hh*2 bd hh*2").bank("tr909").gain(1.1),\n// ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚º\np2: n("0 3 7 10 12 10 7 3").s("synth").release(0.1).cutoff(sine.slow(4).range(400, 2000))` },
      { title: "ã‚¢ãƒ³ãƒ“ã‚¨ãƒ³ãƒˆ", code: `// é•·ã„ãƒ‘ãƒƒãƒ‰ã‚µã‚¦ãƒ³ãƒ‰\np1: n("[c4, e4, g4, b4]").s("synth").release(8).gain(0.7).slow(1),\n// ã‚¢ãƒ«ãƒšã‚¸ã‚ª\np2: n("c5 e5 g5 b5 g5 e5").s("saw").release(0.8).pan(sine.slow(3)).delay(0.5).delaytime(0.75)` }
    ];

    // --- å±¥æ­´ç®¡ç†é–¢æ•° ---
    function loadHistory() {
      const historyJSON = localStorage.getItem('strudelCodeHistory');
      return historyJSON ? JSON.parse(historyJSON) : [];
    }
    function saveCodeToHistory(codeSnippet) {
      if (!codeSnippet || !codeSnippet.match(/p\d+:|s\("|note\("/)) return;
      let history = loadHistory();
      history.unshift(codeSnippet);
      if (history.length > 50) history = history.slice(0, 50);
      localStorage.setItem('strudelCodeHistory', JSON.stringify(history));
    }

    // --- ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ ---
    document.addEventListener("DOMContentLoaded", () => {
      // --- å…±é€šDOMè¦ç´  ---
      const chatInput = document.getElementById("chatInput");
      let isComposing = false;

      // --- ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ ---
      const chatToggleButton = document.getElementById("chatToggleButton");
      const chatBox = document.getElementById("chatBox");
      const sendButton = document.getElementById("sendButton");
      const chatMessages = document.getElementById("chatMessages");
      
      chatToggleButton.addEventListener("click", () => {
        const isHidden = window.getComputedStyle(chatBox).display === "none";
        chatBox.style.display = isHidden ? "flex" : "none";
        if (isHidden) chatInput.focus();
      });
      sendButton.addEventListener("click", () => sendMessage());
      chatInput.addEventListener("keydown", (e) => { if (e.key === "Enter" && !isComposing) { e.preventDefault(); sendMessage(); } });
      chatInput.addEventListener("compositionstart", () => { isComposing = true; });
      chatInput.addEventListener("compositionend", () => { isComposing = false; });
      
      async function sendMessage() {
        const msg = chatInput.value.trim();
        if (!msg) return;
        addBubble(msg, 'user');
        chatInput.value = '';
        const thinkingBubble = addBubble("è€ƒãˆä¸­...", 'ai');

        try {
          const res = await fetch("https://api.openai.com/v1/chat/completions", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${OPENAI_API_KEY}` // APIã‚­ãƒ¼ã‚’Authorizationãƒ˜ãƒƒãƒ€ãƒ¼ã«è¨­å®š
            },
            body: JSON.stringify({
              model: "gpt-4.1", // ä½¿ç”¨ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã‚’gpt-4.1ã«è¨­å®š
              messages: [
                { role: "system", content: strudelAssistantPrompt }, // ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
                { role: "user", content: msg } // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
              ]
            })
          });
          if (!res.ok) throw new Error(`API error: ${res.statusText}`);
          const data = await res.json();
          const reply = data.choices?.[0]?.message?.content || "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
          thinkingBubble.textContent = reply;
          saveCodeToHistory(reply);
        } catch (e) {
          thinkingBubble.textContent = `é€šä¿¡ã‚¨ãƒ©ãƒ¼ã€‚ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ç’°å¢ƒã§å®Ÿè¡Œã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n${e.message}`;
        }
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
      function addBubble(text, type) {
        const bubble = document.createElement("div");
        bubble.className = `chat-bubble ${type}`;
        bubble.textContent = text;
        chatMessages.appendChild(bubble);
        return bubble;
      }

      // --- ã‚³ãƒ¼ãƒ‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ©Ÿèƒ½ ---
      const templateButton = document.getElementById("codeTemplateButton");
      const templateModalOverlay = document.getElementById("templateModalOverlay");
      const templateModalCloseButton = document.getElementById("templateModalCloseButton");
      const genreList = document.getElementById("genreList");
      const codeDisplay = document.getElementById("codeDisplay");
      const templateCopyCodeButton = document.getElementById("templateCopyCodeButton");

      templateButton.addEventListener("click", openTemplateModal);
      templateModalCloseButton.addEventListener("click", () => templateModalOverlay.style.display = 'none');
      templateModalOverlay.addEventListener("click", (e) => { if (e.target === templateModalOverlay) templateModalOverlay.style.display = 'none'; });
      templateCopyCodeButton.addEventListener("click", () => copyCodeToClipboard(codeDisplay.textContent, templateCopyCodeButton));

      function openTemplateModal() {
        if (genreList.children.length === 0) populateTemplateList();
        templateModalOverlay.style.display = 'flex';
      }
      function populateTemplateList() {
        genreList.innerHTML = "";
        codeTemplates.forEach((template, index) => {
          const button = document.createElement("button");
          button.textContent = template.title;
          button.addEventListener("click", () => {
            document.querySelectorAll('.genre-list button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            codeDisplay.textContent = template.code;
          });
          genreList.appendChild(button);
          if (index === 0) button.click();
        });
      }
      
      // --- å±¥æ­´æ©Ÿèƒ½ ---
      const historyButton = document.getElementById("historyButton");
      const historyModalOverlay = document.getElementById("historyModalOverlay");
      const historyModalCloseButton = document.getElementById("historyModalCloseButton");
      const historyList = document.getElementById("historyList");

      historyButton.addEventListener("click", openHistoryModal);
      historyModalCloseButton.addEventListener("click", () => historyModalOverlay.style.display = 'none');
      historyModalOverlay.addEventListener("click", (e) => { if (e.target === historyModalOverlay) historyModalOverlay.style.display = 'none'; });

      function openHistoryModal() {
        populateHistoryList();
        historyModalOverlay.style.display = 'flex';
      }
      function populateHistoryList() {
        const history = loadHistory();
        historyList.innerHTML = "";
        if (history.length === 0) {
          historyList.innerHTML = "<p>ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã®å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
          return;
        }
        history.forEach(codeSnippet => {
          const item = document.createElement("div");
          item.className = "history-item";
          const pre = document.createElement("pre");
          const code = document.createElement("code");
          code.textContent = codeSnippet;
          pre.appendChild(code);
          const copyButton = document.createElement("button");
          copyButton.textContent = "ã‚³ãƒ”ãƒ¼";
          copyButton.className = "copy-code-btn";
          copyButton.onclick = () => copyCodeToClipboard(codeSnippet, copyButton);
          item.appendChild(pre);
      item.appendChild(copyButton);
      historyList.appendChild(item);
    });
  }

  // --- å…±é€šã‚³ãƒ”ãƒ¼é–¢æ•° ---
  function copyCodeToClipboard(text, buttonElement) {
    navigator.clipboard.writeText(text).then(() => {
      const originalText = buttonElement.textContent;
      buttonElement.textContent = "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼";
      setTimeout(() => { buttonElement.textContent = originalText; }, 1500);
    }).catch(err => console.error('Failed to copy text: ', err));
  }
});
</script>
</body>
</html>